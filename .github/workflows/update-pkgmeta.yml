name: Generate Dynamic Package Config

permissions:
  contents: write

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths: ['**/*.lua', '**/*.toc', '**/*.xml']

jobs:
  update-pkgmeta:
    name: Update .pkgmeta with current addon list
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
        with:
          fetch-depth: 0

      # GÃ©nÃ©rer dynamiquement la liste des fichiers Ã  ignorer
      - name: Generate dynamic .pkgmeta
        run: |
          echo "ðŸ“¦ GÃ©nÃ©ration dynamique du .pkgmeta..."
          
          # CrÃ©er le fichier .pkgmeta
          cat > .pkgmeta << 'EOF'
          package-as: GuildLogistics
          
          manual-changelog: CHANGELOG.md
          
          # Fichiers et dossiers de dÃ©veloppement Ã  exclure du package
          ignore:
              - .github/
              - .gitignore
              - .vscode/
              - .pkgmeta
              - cliff.toml
              - README.md
              - CHANGELOG.md
              - LATEST_CHANGELOG.md
          EOF
          
          echo "âœ… .pkgmeta gÃ©nÃ©rÃ© pour structure directe"
          echo ""
          echo "ðŸ“‹ Contenu gÃ©nÃ©rÃ© :"
          cat .pkgmeta

      # VÃ©rifier si le fichier a changÃ©
      - name: Check for changes
        id: check-changes
        run: |
          if git diff --quiet .pkgmeta; then
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Aucun changement dans .pkgmeta"
          else
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "âœ… .pkgmeta mis Ã  jour"
          fi

      # Committer les changements si nÃ©cessaire
      - name: Commit updated .pkgmeta
        if: steps.check-changes.outputs.changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add .pkgmeta
          git commit -m "chore: update .pkgmeta with current addon list [skip ci]"
          git push
